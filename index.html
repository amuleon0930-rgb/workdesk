export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);

    // 只提供一个接口：/news
    if (url.pathname !== "/news") {
      return new Response("OK", { status: 200 });
    }

    // 先读缓存（KV）
    const cached = await env.NEWS_KV.get("today", "json");
    if (cached) {
      return json(cached);
    }

    // 没缓存就现拉现算（首次访问会慢一点）
    const data = await buildNews(env);
    await env.NEWS_KV.put("today", JSON.stringify(data), { expirationTtl: 60 * 60 * 18 }); // 18小时
    return json(data);
  },

  async scheduled(event, env, ctx) {
    // 每天定时刷新缓存
    const data = await buildNews(env);
    await env.NEWS_KV.put("today", JSON.stringify(data), { expirationTtl: 60 * 60 * 24 });
  }
};

function json(obj) {
  return new Response(JSON.stringify(obj), {
    headers: {
      "content-type": "application/json; charset=utf-8",
      "cache-control": "no-store"
    }
  });
}

/**
 * 1) 拉取资讯（这里用 Google News RSS 举例）
 * 2) 调用 OpenAI 总结成中文要点
 */
async function buildNews(env) {
  const now = new Date();
  const date = now.toISOString().slice(0, 10);

  // 你也可以改成更精准的关键词组合
  const rssUrl =
    "https://news.google.com/rss/search?q=" +
    encodeURIComponent('("TikTok Shop" OR TikTok) (seller OR shipping OR policy OR ads)') +
    "&hl=en-US&gl=US&ceid=US:en";

  const rssText = await fetch(rssUrl, {
    headers: { "user-agent": "aio-workdesk/1.0" }
  }).then(r => r.text());

  const items = parseRssItems(rssText).slice(0, 10);

  const titles = items.map((it, i) => `${i + 1}. ${it.title}`).join("\n");
  const prompt = `
你是跨境电商团队的情报编辑。
下面是今天抓取到的新闻标题列表（主要与 TikTok / TikTok Shop 卖家、物流、政策、广告相关）。
请输出：
1）用中文写 4-7 条“今日要点”，每条一句话，极度精炼，面向运营团队，可直接读懂。
2）不要输出英文。
3）不要输出“关键词/算法说明/免责声明”等多余信息。
4）如果标题重复或意义不大，请合并或忽略。

标题列表：
${titles}
`.trim();

  const bullets = await openaiSummarize(env, prompt);

  return {
    date,
    bullets,
    sources: items.map(it => ({
      title: it.title,
      url: it.link,
      source: it.source || "",
      published: it.pubDate || ""
    }))
  };
}

/**
 * OpenAI Responses API（服务端调用）
 * 说明：务必把 OPENAI_API_KEY 配成 Worker 环境变量
 */
async function openaiSummarize(env, prompt) {
  if (!env.OPENAI_API_KEY) {
    return ["未配置 OPENAI_API_KEY（请在 Cloudflare Worker 的环境变量里添加）"];
  }

  const res = await fetch("https://api.openai.com/v1/responses", {
    method: "POST",
    headers: {
      "authorization": `Bearer ${env.OPENAI_API_KEY}`,
      "content-type": "application/json"
    },
    body: JSON.stringify({
      model: env.OPENAI_MODEL || "gpt-5.2",
      input: prompt
    })
  });

  if (!res.ok) {
    const t = await res.text();
    return [`AI 总结失败：HTTP ${res.status}`, t.slice(0, 200)];
  }

  const data = await res.json();
  // Responses API 输出字段结构可能包含 output_text
  const text = (data.output_text || "").trim();
  if (!text) return ["AI 未返回内容"];

  // 允许模型返回用换行分点：我们统一成 bullets 数组
  const lines = text
    .split(/\n+/)
    .map(s => s.replace(/^\s*[-•\d.、]+\s*/, "").trim())
    .filter(Boolean);

  // 最多取 7 条
  return lines.slice(0, 7);
}

/**
 * 超轻量 RSS 解析（足够用）
 */
function parseRssItems(xml) {
  const items = [];
  const blocks = xml.split("<item>").slice(1);
  for (const b of blocks) {
    const seg = b.split("</item>")[0] || "";
    const title = pickTag(seg, "title");
    const link = pickTag(seg, "link");
    const pubDate = pickTag(seg, "pubDate");
    // Google News 的 source 标签有时是 <source url="...">xxx</source>
    const source = (seg.match(/<source[^>]*>([\s\S]*?)<\/source>/i)?.[1] || "").trim();
    if (title && link) {
      items.push({ title: decodeHtml(title), link: decodeHtml(link), pubDate: decodeHtml(pubDate), source: decodeHtml(source) });
    }
  }
  return items;
}

function pickTag(s, tag) {
  const m = s.match(new RegExp(`<${tag}[^>]*>([\\s\\S]*?)<\\/${tag}>`, "i"));
  return m ? m[1].trim() : "";
}

function decodeHtml(str) {
  return str
    .replace(/<!\[CDATA\[(.*?)\]\]>/g, "$1")
    .replace(/&amp;/g, "&")
    .replace(/&lt;/g, "<")
    .replace(/&gt;/g, ">")
    .replace(/&quot;/g, '"')
    .replace(/&#39;/g, "'");
}
